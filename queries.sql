-- Get UID of a user
SELECT UID FROM USER WHERE EMAIL = 'zqzhang@bu.edu';

-- Register.
INSERT INTO USER (EMAIL, PASSWORD, FNAME, LNAME, GENDER) VALUES ('chahuang@bu.edu', 'hello', 'Charles', 'Huang', 'M');

-- Check if an email address has already been used.
SELECT * FROM USER WHERE EMAIL = 'zqzhang@bu.edu';

-- List all friends of a user.
SELECT F.UID2, U.EMAIL, U.FNAME, U.LNAME
FROM FRIENDSHIP F, USER U
WHERE F.UID1 = 3 AND F.UID2 = U.UID;

-- Find friends to add.
SELECT UID, EMAIL, FNAME, LNAME
FROM USER
WHERE EMAIL = 'zqzhang@bu.edu' AND FNAME = 'Zuoqi' AND LNAME = 'Zhang';

-- Add a new friend.
INSERT INTO FRIENDSHIP VALUES (1, 2);
INSERT INTO FRIENDSHIP VALUES (2, 1);

-- Recommend a new friend.
SELECT U.UID, U.EMAIL, U.FNAME, U.LNAME
FROM USER U, FRIENDSHIP F1, FRIENDSHIP F2
WHERE F1.UID1 = 'zqzhang'
  AND F1.UID2 = F2.UID1
  AND F2.UID2 <> F1.UID1
  AND U.UID = F2.UID2
  AND (F1.UID1, F2.UID2) NOT IN ( SELECT * FROM FRIENDSHIP F )
GROUP BY F2.UID2
ORDER BY COUNT(*) DESC;

-- Find top 10 users.
SELECT U.UID, U.EMAIL, U.FNAME, U.LNAME, TMP1.photoCnt + TMP2.commentCnt AS TOTAL
FROM USER U,
    ( SELECT A.UID , COUNT(*) AS photoCnt
      FROM PHOTO P, ALBUM A
      WHERE P.AID = A.AID
      GROUP BY A.UID
    ) AS TMP1,
    ( SELECT C.UID, COUNT(*) AS commentCnt
      FROM COMMENT C
      GROUP BY C.UID
    ) AS TMP2
WHERE U.UID = TMP1.UID AND TMP1.UID = TMP2.UID
GROUP BY U.UID
ORDER BY TOTAL DESC
LIMIT 10;

-- Leave a comment. (Users cannot leave comments for their own photos.)
SELECT A.UID
FROM PHOTO P, ALBUM A
WHERE P.AID = A.AID AND PID = 1;

INSERT INTO COMMENT (CONTENT, UID, PID) VALUES ('', 3, 1);

-- Add a like to a photo.
INSERT INTO FAVORITE (UID, PID) VALUES (3, 1);

-- Display likes.
SELECT COUNT(*) FROM FAVORITE WHERE PID = 1;

SELECT U.UID, U.FNAME, U.LNAME
FROM FAVORITE F, USER U
WHERE F.UID = U.UID AND F.PID = 1;

-- Show all tags of your photos.
SELECT DISTINCT AE.HASHTAG
FROM PHOTO P, ALBUM AM, ASSOCIATE AE
WHERE P.PID = AE.PID AND P.AID = AM.AID AND AM.UID = 3;

-- Show your photos by tag name.
SELECT P.PID, P.DATA
FROM PHOTO P, ALBUM AM, ASSOCIATE AE
WHERE P.PID = AE.PID AND P.AID = AM.AID AND AE.HASHTAG = 'boston';

-- Show all photos by tag name.
SELECT P.PID, P.DATA
FROM PHOTO P, ASSOCIATE A
WHERE P.PID = A.PID AND A.HASHTAG = 'boston';

-- Show the most popular tags.
SELECT HASHTAG
FROM ASSOCIATE
GROUP BY HASHTAG
ORDER BY HASHTAG DESC;

-- Search photos by tags.
SELECT P.PID, P.DATA
FROM PHOTO P, ASSOCIATE A
WHERE P.PID = A.PID AND A.HASHTAG = 'boston';


-- You may also like (NEEDS TESTING)
SELECT DISTINCT P3.PID, P3.CAPTION, P3.DATA -- ALL PHOTOS WITH 5 TO 1 OF THE TOP TAGS AND LEAST TO GREATEST TOTAL TAGS
FROM PHOTO P3,
    ASSOCIATE AE3,
    (SELECT DISTINCT P2.PID P2ID, COUNT(AE2.HASHTAG) C2
    FROM PHOTO P2,
        ASSOCIATE AE2,
        (SELECT TOP 5 DISTINCT AE.HASHTAG AEHT, COUNT(AEHT) C
        FROM USER U, ALBUM AM, PHOTO P, ASSOCIATE AE
        WHERE U.UID = AM.UID AND AM.AID = P.AID AND P.PID = AE.PID AND U.UID = '0' -- CURRENT USER ID
        GROUP BY AEHT
        ORDER BY C DESC) AS TOPFIVE -- TOP FIVE TAGS OF CURRENT USER
    WHERE P2.PID = AE2.PID AND AE2.HASHTAG = TOPFIVE.AEHT
    GROUP BY P2.PID
    ORDER BY C2 DESC) AS WITHTOP -- ALL PHOTOS WITH 5 TO 1 OF THE TOP TAGS
WHERE P3.PID = WITHTOP.P2ID AND P3.PID = AE3.PID
GROUP BY P3.PID
ORDER BY WITHTOP.C2 DESC, COUNT(DISTINCT AE3.HASHTAG) ASC;

-- Friend recommendation (NEEDS TESTING)
SELECT DISTINCT U3.UID, U3.FNAME, U3.LNAME -- FRIENDS OF FRIENDS
FROM USER U, FRIENDSHIP F, USER U2, FRIENDSHIP F2, USER U3
WHERE U.UID = F.UID1
  AND F.UID2 = U2.UID
  AND U2.UID = F2.UID1
  AND F2.UID2 = U3.UID
  AND U.UID <> U3.UID
  AND U.UID = '0' -- CURRENT USER ID
GROUP BY U3.UID
ORDER BY COUNT(U3.UID) DESC;
